#!/bin/bash

source /etc/mother-versions

export DEBIAN_FRONTEND=noninteractive

bl 'installing foreman packages'
apt-get install -qqy \
  libcurl4-openssl-dev \
  foreman-postgresql=${FOREMAN_VERSION}* \
  foreman-compute=${FOREMAN_VERSION}* \
  foreman-libvirt=${FOREMAN_VERSION}* \
  foreman-cli=${FOREMAN_VERSION}* \
  ruby-hammer-cli-foreman-bootdisk \
  ruby-hammer-cli-foreman-discovery \
  ruby-foreman-bootdisk \
  ruby-foreman-discovery \
  ruby-foreman-dhcp-browser \
  ruby-foreman-docker \
  ruby-foreman-hooks \
  ruby-puppetdb-foreman 2>/dev/null

bl "installing Passenger"
cd /usr/share/foreman
echo "gem 'passenger'" > bundler.d/passenger.rb
bundle install
bl "passenger installed"

bl "installing NGINX (compiling, this may take a while...)"
bundle exec passenger-install-nginx-module --auto --auto-download 2>&1 | tee /tmp/nginx_install_log.txt
mkdir -p /opt/nginx/ssl
bl "NGINX installed"

bl "configuring NGINX for passenger"
PASSENGER_ROOT=`egrep 'passenger_root\ \/' /tmp/nginx_install_log.txt | awk '{ print $2 }' | sed s/\;//`
PASSENGER_RUBY=`egrep 'passenger_ruby\ \/' /tmp/nginx_install_log.txt | awk '{ print $2 }' | sed s/\;//`
echo "# this config is autogenerated by docker build
user foreman;
worker_processes 10;
daemon off;
events {
  worker_connections 1024;
}
http {
  passenger_root ${PASSENGER_ROOT};
  passenger_ruby ${PASSENGER_RUBY};
  passenger_max_pool_size 15;
  passenger_min_instances 2;
  passenger_pool_idle_time 15;
  passenger_user_switching on;
  include mime.types;
  default_type application/octet-stream;
  sendfile on;
  keepalive_timeout 120;
  client_body_buffer_size 100m;
  gzip on;
  include /opt/nginx/conf/foreman.conf;
}
" > /opt/nginx/conf/nginx.conf
bl "NGINX configured"
touch /opt/nginx/conf/foreman.conf
