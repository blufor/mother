#!/bin/bash

set -e
source /etc/mother-versions
export DEBIAN_FRONTEND=noninteractive

bl 'installing Foreman packages...'
apt-get install -qqy \
  libcurl4-openssl-dev \
  apache2-mpm-worker \
  apache2-threaded-dev \
  libapr1-dev \
  libaprutil1-dev \
  foreman-postgresql="${FOREMAN_VERSION}*" \
  foreman-compute="${FOREMAN_VERSION}*" \
  foreman-libvirt="${FOREMAN_VERSION}*" \
  foreman-cli="${FOREMAN_VERSION}*" \
  ruby-hammer-cli-foreman-discovery \
  ruby-foreman-discovery \
  ruby-foreman-dhcp-browser \
  ruby-foreman-templates \
  ruby-foreman-hooks \
  ruby-puppetdb-foreman \
  python-websocket

bl "installing Passenger..."
apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 561F9B9CAC40B2F7
apt-get install -yyy apt-transport-https ca-certificates

# Add our APT repository
echo "deb https://oss-binaries.phusionpassenger.com/apt/passenger trusty main" > /etc/apt/sources.list.d/passenger.list
apt-get update

# Install Passenger + Apache module
apt-get install -yyy libapache2-mod-passenger

bl "Switching Ruby from 1.9 to 2.0"
rm /usr/bin/ruby && ln -s /usr/bin/ruby2.0 /usr/bin/ruby

b "installing Apache's passenger..."
PASSENGER_VER=$(passenger-config about version | cut -d " " -f 3)
PASSENGER_MOD="/usr/lib/apache2/modules/mod_passenger.so"
PASSENGER_ROOT="/usr/share/foreman/vendor/ruby/2.0.0/gems/passenger-${PASSENGER_VER}"
PASSENGER_RUBY="/usr/bin/ruby2.0"
echo "# this config is autogenerated by docker build
LoadModule passenger_module ${PASSENGER_MOD}
<IfModule mod_passenger.c>
  PassengerRoot ${PASSENGER_ROOT}
  PassengerDefaultRuby ${PASSENGER_RUBY}
  PassengerHighPerformance on
  PassengerMaxPoolSize 12
  PassengerPoolIdleTime 1500
  PassengerStatThrottleRate 120
  PassengerEnabled On
</IfModule>
" > /etc/apache2/mods-available/passenger.load
a2enmod passenger &>/dev/null
bl "done"

b "reconfiguring listen ports..."
echo "# this config is autogenerated by docker build
Listen 80
Listen 443
" > /etc/apache2/ports.conf
bl "done"

b "preparing Foreman's VirtualHost..."
touch /etc/apache2/sites-available/foreman.conf
a2ensite foreman &>/dev/null
b "cleaning"
apt-get clean
apt-get autoremove -yyy
bl 'done'
