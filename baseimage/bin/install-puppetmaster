#!/bin/bash

set -e
source /etc/mother-versions
export DEBIAN_FRONTEND=noninteractive

bl "installing Puppetmaster..."
apt-get -qqy install \
  puppetmaster="${PUPPET_VERSION}*" \
  puppetdb-terminus \
  hiera \
  libssl-dev \
  libcurl4-openssl-dev \
  zlib1g-dev \
  ruby-dev

bl "installing nginx + phussion passenger"
apt-get update
apt-get install nginx-extras passenger -yyy

PASSENGER_VER=$(passenger-config about version | cut -d " " -f 3)
PASSENGER_ROOT="/usr/share/foreman/vendor/ruby/1.9.1/gems/passenger-${PASSENGER_VER}"
PASSENGER_RUBY="/usr/bin/ruby"

bl "installing Puppet Librarian..."
gem install librarian-puppet --no-rdoc --no-ri

bl "installing Foreman reporter & ENC..."
curl -q https://raw.githubusercontent.com/theforeman/puppet-foreman/master/files/foreman-report_v2.rb > /usr/lib/ruby/vendor_ruby/puppet/reports/foreman.rb
curl -q https://raw.githubusercontent.com/theforeman/puppet-foreman/master/files/external_node_v2.rb > /usr/lib/ruby/vendor_ruby/node.rb
chmod a+x /usr/lib/ruby/vendor_ruby/node.rb

bl "configuring NGINX for passenger"
echo "# this config is autogenerated by docker build
user puppet;
worker_processes 10;
daemon off;
events {
  worker_connections 1024;
}
http {
  passenger_root ${PASSENGER_ROOT};
  passenger_ruby ${PASSENGER_RUBY};
  passenger_max_pool_size 15;
  passenger_min_instances 2;
  passenger_pool_idle_time 15;
  passenger_user_switching on;
  include mime.types;
  default_type application/octet-stream;
  sendfile on;
  keepalive_timeout 120;
  client_body_buffer_size 100m;
  gzip on;
  include /etc/nginx/conf.d/puppetmaster.conf;
}
" > /etc/nginx/nginx.conf
touch /etc/nginx/conf.d/puppetmaster.conf
